"""
Servicio para comunicaci√≥n con la API de autenticaci√≥n externa
Adaptado para trabajar con HTTPS y manejo de roles
"""

import requests
import os
from typing import Optional, Dict
from dotenv import load_dotenv
import urllib3

# Deshabilitar advertencias de SSL para desarrollo (localhost)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Cargar variables de entorno
load_dotenv()


class AuthAPIService:
    """Servicio para autenticaci√≥n contra API externa con soporte de roles"""
    
    # Mapeo de roles de la API al sistema local
    ROLE_MAPPING = {
        'admin': 'admin',
        'cliente': 'cliente',
        'usuario_avanzado': 'usuario_avanzado'
    }
    
    def __init__(self):
        # Usar HTTPS en puerto 8443
        self.api_url = os.getenv('AUTH_API_URL', 'https://localhost:8443/auth')
        self.token = None
        self.user_data = None
        self.user_role = None
        
        # DEBUG: Mostrar URL que se est√° usando
        print(f"[DEBUG] API URL configurada: {self.api_url}")
    
    def login(self, correo: str, password: str) -> bool:
        """
        Autenticar contra la API externa
        
        Args:
            correo: Email del usuario
            password: Contrase√±a
            
        Returns:
            True si el login fue exitoso
        """
        try:
            url = f"{self.api_url}/login"
            payload = {
                "correo": correo,
                "password": password
            }
            
            # DEBUG: Mostrar lo que se est√° enviando
            print(f"[DEBUG] URL: {url}")
            print(f"[DEBUG] Payload: {{correo: {correo}, password: ***}}")
            
            # verify=False para desarrollo con certificados self-signed
            response = requests.post(
                url,
                json=payload,
                timeout=10,
                verify=False  # IMPORTANTE: En producci√≥n usar certificados v√°lidos
            )
            
            # DEBUG: Mostrar respuesta
            print(f"[DEBUG] Status Code: {response.status_code}")
            print(f"[DEBUG] Response: {response.text[:200]}...")
            
            if response.status_code == 200:
                data = response.json()
                
                # Extraer token y datos del usuario
                self.token = data.get('token')
                self.user_data = data.get('user_info', {})
                
                # Extraer y mapear el rol
                api_role = self.user_data.get('rol', '').lower()
                print(f"[DEBUG] API Role recibido: '{api_role}'")
                self.user_role = self.ROLE_MAPPING.get(api_role, 'cliente')
                print(f"[DEBUG] Role mapeado: '{self.user_role}'")
                
                print(f"[DEBUG] ‚úÖ Login exitoso")
                print(f"[DEBUG] Token recibido: {self.token[:20]}..." if self.token else "[DEBUG] No token")
                print(f"[DEBUG] Usuario: {self.user_data.get('nombre', 'N/A')}")
                print(f"[DEBUG] Email: {self.user_data.get('email', 'N/A')}")
                print(f"[DEBUG] Rol final: {self.user_role}")
                
                return True
            
            print(f"[DEBUG] ‚ùå Login fall√≥ con status {response.status_code}")
            return False
            
        except requests.exceptions.SSLError as e:
            print(f"[ERROR] Error de SSL (certificado): {e}")
            print("[INFO] Aseg√∫rate de que el servidor est√© usando HTTPS correctamente")
            return False
        except requests.exceptions.ConnectionError as e:
            print(f"[ERROR] No se puede conectar con la API: {e}")
            print(f"[INFO] Verifica que el servicio est√© corriendo en {self.api_url}")
            return False
        except requests.exceptions.Timeout as e:
            print(f"[ERROR] Timeout al conectar con la API: {e}")
            return False
        except Exception as e:
            print(f"[ERROR] Error inesperado en login: {e}")
            import traceback
            traceback.print_exc()
            return False
    
    def verify_token(self) -> bool:
        """
        Verificar si el token actual es v√°lido
        
        Returns:
            True si el token es v√°lido
        """
        if not self.token:
            print("[DEBUG] No hay token para verificar")
            return False
        
        try:
            url = f"{self.api_url}/verify-token"
            
            response = requests.post(
                url,
                headers={
                    "Authorization": f"Bearer {self.token}"
                },
                timeout=5,
                verify=False  # Para desarrollo
            )
            
            is_valid = response.status_code == 200
            print(f"[DEBUG] Token v√°lido: {is_valid}")
            
            return is_valid
            
        except Exception as e:
            print(f"[ERROR] Error verificando token: {e}")
            return False
    
    def check_health(self) -> bool:
        """
        Verificar si la API de autenticaci√≥n est√° disponible
        
        Returns:
            True si la API responde correctamente
        """
        try:
            url = f"{self.api_url}/health"
            
            response = requests.get(
                url,
                timeout=5,
                verify=False
            )
            
            is_healthy = response.status_code == 200
            print(f"[DEBUG] API Health Check: {'‚úÖ OK' if is_healthy else '‚ùå FAIL'}")
            
            return is_healthy
            
        except Exception as e:
            print(f"[ERROR] API no disponible: {e}")
            return False
    
    def get_user_data(self) -> Optional[Dict]:
        """
        Obtiene los datos del usuario autenticado
        
        Returns:
            Diccionario con datos del usuario o None
        """
        return self.user_data
    
    def get_user_role(self) -> Optional[str]:
        """
        Obtiene el rol del usuario autenticado
        
        Returns:
            String con el rol del usuario o None
        """
        return self.user_role
    
    def get_user_email(self) -> Optional[str]:
        """
        Obtiene el email del usuario autenticado
        
        Returns:
            Email del usuario o None
        """
        return self.user_data.get('email') if self.user_data else None
    
    def get_user_name(self) -> Optional[str]:
        """
        Obtiene el nombre del usuario autenticado
        
        Returns:
            Nombre del usuario o None
        """
        return self.user_data.get('nombre') if self.user_data else None
    
    def is_authenticated(self) -> bool:
        """
        Verifica si hay un usuario autenticado
        
        Returns:
            True si hay sesi√≥n activa
        """
        return self.token is not None and self.user_data is not None
    
    def has_role(self, role: str) -> bool:
        """
        Verifica si el usuario tiene un rol espec√≠fico
        
        Args:
            role: Rol a verificar ('admin', 'cliente', 'usuario_avanzado')
            
        Returns:
            True si el usuario tiene ese rol
        """
        return self.user_role == role.lower()
    
    def logout(self):
        """Cerrar sesi√≥n y limpiar datos"""
        print("[DEBUG] Cerrando sesi√≥n...")
        self.token = None
        self.user_data = None
        self.user_role = None
        print("[DEBUG] ‚úÖ Sesi√≥n cerrada")


# Funciones de utilidad para usar en el CLI

def login_prompt(auth_service: AuthAPIService) -> bool:
    """
    Muestra un prompt de login y autentica al usuario
    
    Args:
        auth_service: Instancia del servicio de autenticaci√≥n
        
    Returns:
        True si el login fue exitoso
    """
    print("\n" + "="*50)
    print("  üîê PUCP Cloud Orchestrator - Login")
    print("="*50)
    
    correo = input("üìß Email: ").strip()
    
    # Importar getpass para ocultar password
    from getpass import getpass
    password = getpass("üîë Password: ")
    
    print("\n‚è≥ Autenticando...")
    
    if auth_service.login(correo, password):
        print(f"\n‚úÖ Bienvenido, {auth_service.get_user_name()}!")
        print(f"üë§ Rol: {auth_service.get_user_role()}")
        return True
    else:
        print("\n‚ùå Credenciales inv√°lidas")
        return False


def require_role(auth_service: AuthAPIService, required_role: str) -> bool:
    """
    Verifica si el usuario tiene el rol requerido
    
    Args:
        auth_service: Instancia del servicio de autenticaci√≥n
        required_role: Rol requerido
        
    Returns:
        True si el usuario tiene el rol necesario
    """
    if not auth_service.is_authenticated():
        print("‚ùå Debe iniciar sesi√≥n primero")
        return False
    
    if not auth_service.has_role(required_role):
        print(f"‚ùå Acceso denegado. Se requiere rol: {required_role}")
        print(f"   Tu rol actual: {auth_service.get_user_role()}")
        return False
    
    return True


# Ejemplo de uso
if __name__ == "__main__":
    # Crear instancia del servicio
    auth = AuthAPIService()
    
    # Verificar salud de la API
    print("\nüè• Verificando disponibilidad de la API...")
    if not auth.check_health():
        print("‚ö†Ô∏è  La API de autenticaci√≥n no est√° disponible")
        print("üí° Aseg√∫rate de que el servicio Docker est√© corriendo:")
        print("   sudo docker compose up -d")
        exit(1)
    
    # Prompt de login
    if login_prompt(auth):
        # Verificar token
        print("\nüîç Verificando token...")
        if auth.verify_token():
            print("‚úÖ Token v√°lido")
        
        # Mostrar informaci√≥n del usuario
        print("\n" + "="*50)
        print("üìã Informaci√≥n de sesi√≥n:")
        print(f"   Nombre: {auth.get_user_name()}")
        print(f"   Email: {auth.get_user_email()}")
        print(f"   Rol: {auth.get_user_role()}")
        print("="*50)
        
        # Ejemplo de verificaci√≥n de roles
        print("\nüîê Verificando permisos...")
        if require_role(auth, 'admin'):
            print("‚úÖ Tienes permisos de administrador")
        else:
            print("‚ÑπÔ∏è  No tienes permisos de administrador")
        
        # Cerrar sesi√≥n
        auth.logout()
    else:
        print("\n‚ö†Ô∏è  No se pudo iniciar sesi√≥n")